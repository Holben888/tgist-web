<main>
  {#each transcripts as transcript, index}
  <section class="{transcript.collapsed ? 'collapsed' : ''}">
    {#each transcript as entry}
    {#if index < transcripts.length - 1}
      <p></p>
    {/if}
    <div class="entry-container">
      <p class="label">{capitalize(entry.speaker)}</p>
      <p>
        <span>{entry.recognized}</span>
        <span class="recognizing">{entry.recognizing}</span>
      </p>
    </div>
    {/each}
  </section>
  {/each}
  <div class="smilometer-container">
    <Smilometer sentiment="{sentiment}" />
  </div>
</main>

<style>
  main {
    display: flex;
    flex-direction: column;
    margin-left: 5%;
  }
  .smilometer-container {
    position: fixed;
    right: 5%;
    top: 15rem;
  }
  section {
    border-radius: 1rem;
    background: white;
    box-shadow: var(--container-shadow);
    padding: 2rem;
    min-height: 100vh;
    font-family: open-sans;
    color: var(--grey-1);
    width: 83%;
    font-family: open-sans, sans-serif;
    margin-top: 10rem;
  }
  section.collapsed {
    overflow: hidden;
    height: 4rem;
    min-height: 0;
  }
  .entry-container {
    display: flex;
  }
  .label {
    min-width: 8rem;
    text-align: right;
    font-weight: 600;
    padding-right: 1rem;
  }
  p > .recognizing {
    color: var(--grey-5);
  }
</style>

<script>
  import { onMount, beforeUpdate } from 'svelte'
  import Smilometer from './Smilometer.html'
  import processAnalytics from './analytics';

  let transcripts = [[], []]
  let sentiment = 0

  const capitalize = word =>
    word && word.length ? word[0].toUpperCase() + word.slice(1) : ''

  const lastLogs = {}

  onMount(() => {
    const socket = new WebSocket(
      'wss://tgist-server-tawzkzwulm.now.sh/ws/speech/recv'
    )

    setInterval(() => {
      sentiment = Math.random() * 100
    }, 2000)

    socket.onmessage = event => {
      const transcript = transcripts[transcripts.length - 1]
      const { speaker, type, result } = JSON.parse(event.data)
      const lastEntry = transcript.length
        ? transcript[transcript.length - 1]
        : {}

      if (lastEntry.speaker === speaker) {
        lastLogs[speaker] = lastEntry
      }

      if (!lastLogs[speaker]) {
        if (type === 'recognized') {
          lastLogs[speaker] = {
            speaker: speaker,
            recognized: result,
            recognizing: '',
            important: true,
          }
        } else {
          lastLogs[speaker] = {
            speaker: speaker,
            recognized: '',
            recognizing: result,
            important: true,
          }
        }
        transcript.push(lastLogs[speaker])
      } else {
        if (type === 'recognized') {
          lastLogs[speaker].recognized += ' ' + result
          lastLogs[speaker].recognizing = ''
        } else {
          lastLogs[speaker].recognizing = result
        }
      }

      if (type === 'recognized') {
        lastLogs[speaker] = undefined
        processAnalytics(transcript);
      }
      transcript = [...transcript]
    }
  })
</script>
